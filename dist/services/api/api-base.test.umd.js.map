{"version":3,"file":"api-base.test.umd.js","sources":["../../../src/services/api/api-base.js","../../../src/services/api/api-base.test.js"],"sourcesContent":["import axios from 'axios'\r\nimport { isFunction } from 'lodash'\r\nimport * as Vue from 'vue'\r\n\r\nlet sitePrefixUrl = 'https://api.cbd.int';\r\n\r\nif(/\\.cbd\\.int$/i   .test(window?.location?.hostname || '')) sitePrefixUrl= 'https://api.cbd.int';\r\nif(/\\.cbddev\\.xyz$/i.test(window?.location?.hostname || '')) sitePrefixUrl= 'https://api.cbddev.xyz';\r\nif(/\\localhost$/i   .test(window?.location?.hostname || '')) sitePrefixUrl= '/';\r\n\r\nconst defaultOptions = { \r\n   prefixUrl:  sitePrefixUrl, \r\n   timeout  : 30 * 1000,\r\n   token: Vue?.prototype?.$auth?.strategy?.token?.get()  \r\n}\r\n\r\nexport default class ApiBase\r\n{\r\n  constructor(options) {\r\n    options = options || {};\r\n\r\n    if(isFunction(options)) options = { token : options }\r\n\r\n    const { token, prefixUrl, timeout, tokenType } = { ...defaultOptions, ...options }\r\n\r\n    this.config = {\r\n      baseURL : prefixUrl,\r\n      timeout,\r\n      tokenType,\r\n      token,\r\n    }\r\n\r\n    const http = async function (...args) {   \r\n      return (await loadAsyncHeaders(this.config))(...args);\r\n    }\r\n\r\n    http.get     = async (...args)=> (await loadAsyncHeaders(this.config)).get    (...args);\r\n    http.head    = async (...args)=> (await loadAsyncHeaders(this.config)).head   (...args);\r\n    http.post    = async (...args)=> (await loadAsyncHeaders(this.config)).post   (...args);\r\n    http.put     = async (...args)=> (await loadAsyncHeaders(this.config)).put    (...args);\r\n    http.patch   = async (...args)=> (await loadAsyncHeaders(this.config)).patch  (...args);\r\n    http.delete  = async (...args)=> (await loadAsyncHeaders(this.config)).delete (...args);\r\n    http.options = async (...args)=> (await loadAsyncHeaders(this.config)).options(...args);\r\n    http.request = async (...args)=> (await loadAsyncHeaders(this.config)).request(...args);\r\n\r\n    this.http = http;\r\n  }\r\n}\r\n\r\nasync function loadAsyncHeaders(baseConfig) {\r\n\r\n  const { token, tokenType, ...config } = baseConfig || {}\r\n\r\n  const headers = { ...(config.headers || {}) };\r\n\r\n  if(token) {\r\n      headers.Authorization = `${tokenType||'Bearer'} ${token}`;\r\n  }\r\n\r\n  return axios.create({ ...config, headers } );\r\n\r\n}\r\n\r\n//////////////////////////\r\n// Helpers\r\n////////////////////////\r\n\r\nexport function tryCastToApiError(error) {\r\n\r\n  if(error && error.response && error.response.data && error.response.data.code) {\r\n      const apiError = error.response.data\r\n      throw error.response.data;\r\n  }\r\n\r\n  throw error\r\n}\r\n\r\nexport function stringifyUrlParam(value) {\r\n  if (value instanceof(Date))   {return value.toISOString()}    \r\n  if (value instanceof(Object)) {return JSON.stringify(value)}  \r\n  return value; \r\n}\r\n\r\nexport function stringifyUrlParams(valueObj) {\r\n  const returnObj = {};\r\n\r\n  for (const [key, value] of Object.entries(valueObj)) {\r\n    if (isValid(value)){\r\n      returnObj[key] = stringifyUrlParam(value);\r\n    }\r\n  }\r\n  \r\n  return returnObj;\r\n}\r\n\r\nexport function mapObjectId(id){  \r\n  return isObjectId(id)? { $oid: id } : id\r\n}\r\n\r\nexport function isObjectId(id){\r\n  return /^[a-f0-9]{24}/i.test(id);\r\n}\r\n\r\nexport function isValid(params){\r\n  return ![undefined, null].includes(params);\r\n}","/**\r\n * @vitest-environment jsdom\r\n */\r\n\r\ntest('use jsdom in this test file', () => {\r\n  const element = document.createElement('div')\r\n  expect(element).not.toBeNull()\r\n})\r\n\r\nimport { expect, test } from 'vitest'\r\nimport { mapObjectId, isObjectId, stringifyUrlParam, stringifyUrlParams } from './api-base'\r\n\r\ntest('isObjectId Test:', () => {\r\n   expect.soft(isObjectId(1)).toBe(false);\r\n   expect.soft(isObjectId(\"aaaabbbbccccdddd00001111\")).toBe(true);\r\n})\r\n\r\ntest('mapObjectId Test:', () => {\r\n    expect.soft(mapObjectId(\"aaaabbbbccccdddd00001111\")).toEqual({$oid: \"aaaabbbbccccdddd00001111\" });\r\n})\r\n\r\ntest('Params -> URL Param',() => {\r\n  expect.soft(stringifyUrlParam(\"I am a string\")).toEqual(\"I am a string\");\r\n  expect.soft(stringifyUrlParam(1)).toBe(1);\r\n  expect.soft(stringifyUrlParam(new Date(\"2024-09-13T05:00:00.000+05:00\"))).toBe(\"2024-09-13T00:00:00.000Z\");\r\n  expect.soft(stringifyUrlParam({name: \"John\", age: 30, city: \"New York\"})).toEqual('{\"name\":\"John\",\"age\":30,\"city\":\"New York\"}');\r\n}) \r\n\r\n\r\ntest('Param list -> URL Params',() => {\r\n  expect.soft(stringifyUrlParams({q:1, f:2, s:1, sk:0, l:0 , c:0, fo:1, ag:1})).toEqual({\"q\":1,\"f\":2,\"s\":1,\"sk\":0,\"l\":0,\"c\":0,\"fo\":1,\"ag\":1 });\r\n  expect.soft(stringifyUrlParams({q:{firstName:\"john\",lastName:\"smith\"}, f:2, s:1, sk:0, l:0 , c:0, fo:1, ag:1})).toEqual({\"q\":'{\"firstName\":\"john\",\"lastName\":\"smith\"}',\"f\":2,\"s\":1,\"sk\":0,\"l\":0,\"c\":0,\"fo\":1,\"ag\":1 });\r\n}) \r\n\r\n\r\n\r\n \r\n\r\n\r\n\r\n\r\n"],"names":["sitePrefixUrl","test","_window","window","location","hostname","_window2","_window3","prefixUrl","timeout","token","Vue","_Vue__namespace$proto","prototype","$auth","strategy","get","stringifyUrlParam","value","Date","toISOString","Object","JSON","stringify","stringifyUrlParams","valueObj","returnObj","key","entries","isValid","mapObjectId","id","isObjectId","$oid","params","undefined","includes","vitest","element","document","createElement","expect","not","toBeNull","soft","toBe","toEqual","name","age","city","q","f","s","sk","l","c","fo","ag","firstName","lastName"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;EAIA,IAAIA,aAAa,GAAG,qBAAqB;EAEzC,IAAG,cAAc,CAAIC,IAAI,CAAC,EAAAC,OAAA,GAAAC,MAAM,cAAAD,OAAA,gBAAAA,OAAA,GAANA,OAAA,CAAQE,QAAQ,cAAAF,OAAA,uBAAhBA,OAAA,CAAkBG,QAAQ,KAAI,EAAE,CAAC,EAAEL,aAAa,GAAE,qBAAqB;EACjG,IAAG,iBAAiB,CAACC,IAAI,CAAC,EAAAK,QAAA,GAAAH,MAAM,cAAAG,QAAA,gBAAAA,QAAA,GAANA,QAAA,CAAQF,QAAQ,cAAAE,QAAA,uBAAhBA,QAAA,CAAkBD,QAAQ,KAAI,EAAE,CAAC,EAAEL,aAAa,GAAE,wBAAwB;EACpG,IAAG,cAAc,CAAIC,IAAI,CAAC,EAAAM,QAAA,GAAAJ,MAAM,cAAAI,QAAA,gBAAAA,QAAA,GAANA,QAAA,CAAQH,QAAQ,cAAAG,QAAA,uBAAhBA,QAAA,CAAkBF,QAAQ,KAAI,EAAE,CAAC,EAAEL,aAAa,GAAE,GAAG;EAExD,CAAA;IACpBQ,SAAS,EAAGR,aAAa;IACzBS,OAAO,EAAI,EAAE,GAAG,IAAI;IACpBC,KAAK,EAAEC,cAAG,aAAHA,cAAG,gBAAAC,qBAAA,GAAHD,cAAG,CAAEE,SAAS,cAAAD,qBAAA,gBAAAA,qBAAA,GAAdD,qBAAAA,CAAgBG,KAAK,cAAAF,qBAAA,gBAAAA,qBAAA,GAArBD,qBAAAA,CAAuBI,QAAQ,cAAAH,qBAAA,gBAAAA,qBAAA,GAA/BD,qBAAAA,CAAiCD,KAAK,cAAAE,qBAAA,uBAAtCD,qBAAAA,CAAwCK,GAAG,CAAE;EACvD,CAAC;EA+DM,SAASC,iBAAiBA,CAACC,KAAK,EAAE;IACvC,IAAIA,KAAK,YAAYC,IAAK,EAAI;MAAC,OAAOD,KAAK,CAACE,WAAW,CAAA,CAAE;IAAA;IACzD,IAAIF,KAAK,YAAYG,MAAO,EAAE;MAAC,OAAOC,IAAI,CAACC,SAAS,CAACL,KAAK,CAAC;IAAA;IAC3D,OAAOA,KAAK;EACd;EAEO,SAASM,kBAAkBA,CAACC,QAAQ,EAAE;IAC3C,MAAMC,SAAS,GAAG,CAAA,CAAE;IAEpB,KAAK,MAAM,CAACC,GAAG,EAAET,KAAK,CAAC,IAAIG,MAAM,CAACO,OAAO,CAACH,QAAQ,CAAC,EAAE;MACnD,IAAII,OAAO,CAACX,KAAK,CAAC,EAAC;QACjBQ,SAAS,CAACC,GAAG,CAAC,GAAGV,iBAAiB,CAACC,KAAK,CAAC;MAC1C;IACF;IAED,OAAOQ,SAAS;EAClB;EAEO,SAASI,WAAWA,CAACC,EAAE,EAAC;IAC7B,OAAOC,UAAU,CAACD,EAAE,CAAC,GAAE;MAAEE,IAAI,EAAEF;IAAI,CAAA,GAAGA,EAAE;EAC1C;EAEO,SAASC,UAAUA,CAACD,EAAE,EAAC;IAC5B,OAAO,gBAAgB,CAAC9B,IAAI,CAAC8B,EAAE,CAAC;EAClC;EAEO,SAASF,OAAOA,CAACK,MAAM,EAAC;IAC7B,OAAO,CAAC,CAACC,SAAS,EAAE,IAAI,CAAC,CAACC,QAAQ,CAACF,MAAM,CAAC;EAC5C;;ECzGA;AACA;AACA;;EAEIG,MAAA,CAAApC,IAAA,CAAC,6BAA6B,EAAE,MAAM;IACxC,MAAMqC,OAAO,GAAGC,QAAQ,CAACC,aAAa,CAAC,KAAK,CAAC;IAC7CC,MAAAA,CAAAA,MAAM,CAACH,OAAO,CAAC,CAACI,GAAG,CAACC,QAAQ,CAAE,CAAA;EAChC,CAAC,CAAC;EAKEN,MAAA,CAAApC,IAAA,CAAC,kBAAkB,EAAE,MAAM;IAC5BwC,MAAM,CAAAA,MAAA,CAACG,IAAI,CAACZ,UAAU,CAAC,CAAC,CAAC,CAAC,CAACa,IAAI,CAAC,KAAK,CAAC;IACtCJ,MAAM,CAAAA,MAAA,CAACG,IAAI,CAACZ,UAAU,CAAC,0BAA0B,CAAC,CAAC,CAACa,IAAI,CAAC,IAAI,CAAC;EACjE,CAAC,CAAC;EAEER,MAAA,CAAApC,IAAA,CAAC,mBAAmB,EAAE,MAAM;IAC5BwC,aAAM,CAACG,IAAI,CAACd,WAAW,CAAC,0BAA0B,CAAC,CAAC,CAACgB,OAAO,CAAC;MAACb,IAAI,EAAE;IAA0B,CAAE,CAAC;EACrG,CAAC,CAAC;EAEEI,MAAA,CAAApC,IAAA,CAAC,qBAAqB,EAAC,MAAM;IAC/BwC,MAAM,CAAAA,MAAA,CAACG,IAAI,CAAC3B,iBAAiB,CAAC,eAAe,CAAC,CAAC,CAAC6B,OAAO,CAAC,eAAe,CAAC;IACxEL,MAAM,CAAAA,MAAA,CAACG,IAAI,CAAC3B,iBAAiB,CAAC,CAAC,CAAC,CAAC,CAAC4B,IAAI,CAAC,CAAC,CAAC;IACzCJ,aAAM,CAACG,IAAI,CAAC3B,iBAAiB,CAAC,IAAIE,IAAI,CAAC,+BAA+B,CAAC,CAAC,CAAC,CAAC0B,IAAI,CAAC,0BAA0B,CAAC;IAC1GJ,MAAAA,CAAAA,MAAM,CAACG,IAAI,CAAC3B,iBAAiB,CAAC;MAAC8B,IAAI,EAAE,MAAM;MAAEC,GAAG,EAAE,EAAE;MAAEC,IAAI,EAAE;IAAU,CAAC,CAAC,CAAC,CAACH,OAAO,CAAC,4CAA4C,CAAC;EACjI,CAAC,CAAC;EAGET,MAAA,CAAApC,IAAA,CAAC,0BAA0B,EAAC,MAAM;IACpCwC,aAAM,CAACG,IAAI,CAACpB,kBAAkB,CAAC;MAAC0B,CAAC,EAAC,CAAC;MAAEC,CAAC,EAAC,CAAC;MAAEC,CAAC,EAAC,CAAC;MAAEC,EAAE,EAAC,CAAC;MAAEC,CAAC,EAAC,CAAC;MAAGC,CAAC,EAAC,CAAC;MAAEC,EAAE,EAAC,CAAC;MAAEC,EAAE,EAAC;IAAC,CAAC,CAAC,CAAC,CAACX,OAAO,CAAC;MAAC,GAAG,EAAC,CAAC;MAAC,GAAG,EAAC,CAAC;MAAC,GAAG,EAAC,CAAC;MAAC,IAAI,EAAC,CAAC;MAAC,GAAG,EAAC,CAAC;MAAC,GAAG,EAAC,CAAC;MAAC,IAAI,EAAC,CAAC;MAAC,IAAI,EAAC;IAAC,CAAE,CAAC;IAC5IL,aAAM,CAACG,IAAI,CAACpB,kBAAkB,CAAC;MAAC0B,CAAC,EAAC;QAACQ,SAAS,EAAC,MAAM;QAACC,QAAQ,EAAC;MAAO,CAAC;MAAER,CAAC,EAAC,CAAC;MAAEC,CAAC,EAAC,CAAC;MAAEC,EAAE,EAAC,CAAC;MAAEC,CAAC,EAAC,CAAC;MAAGC,CAAC,EAAC,CAAC;MAAEC,EAAE,EAAC,CAAC;MAAEC,EAAE,EAAC;IAAC,CAAC,CAAC,CAAC,CAACX,OAAO,CAAC;MAAC,GAAG,EAAC,yCAAyC;MAAC,GAAG,EAAC,CAAC;MAAC,GAAG,EAAC,CAAC;MAAC,IAAI,EAAC,CAAC;MAAC,GAAG,EAAC,CAAC;MAAC,GAAG,EAAC,CAAC;MAAC,IAAI,EAAC,CAAC;MAAC,IAAI,EAAC;IAAC,CAAE,CAAC;EACxN,CAAC,CAAA;"}