{"version":3,"file":"api-base.test.cjs","sources":["../../../src/services/api/api-base.js","../../../src/services/api/api-base.test.js"],"sourcesContent":["import axios from 'axios'\r\nimport { isFunction } from 'lodash'\r\nimport * as Vue from 'vue'\r\n\r\nlet sitePrefixUrl = 'https://api.cbd.int';\r\n\r\nif(/\\.cbd\\.int$/i   .test(window?.location?.hostname || '')) sitePrefixUrl= 'https://api.cbd.int';\r\nif(/\\.cbddev\\.xyz$/i.test(window?.location?.hostname || '')) sitePrefixUrl= 'https://api.cbddev.xyz';\r\nif(/\\localhost$/i   .test(window?.location?.hostname || '')) sitePrefixUrl= '/';\r\n\r\nconst defaultOptions = { \r\n   prefixUrl:  sitePrefixUrl, \r\n   timeout  : 30 * 1000,\r\n   token: Vue?.prototype?.$auth?.strategy?.token?.get()  \r\n}\r\n\r\nexport default class ApiBase\r\n{\r\n  constructor(options) {\r\n    options = options || {};\r\n\r\n    if(isFunction(options)) options = { token : options }\r\n\r\n    const { token, prefixUrl, timeout, tokenType } = { ...defaultOptions, ...options }\r\n\r\n    this.config = {\r\n      baseURL : prefixUrl,\r\n      timeout,\r\n      tokenType,\r\n      token,\r\n    }\r\n\r\n    const http = async function (...args) {   \r\n      return (await loadAsyncHeaders(this.config))(...args);\r\n    }\r\n\r\n    http.get     = async (...args)=> (await loadAsyncHeaders(this.config)).get    (...args);\r\n    http.head    = async (...args)=> (await loadAsyncHeaders(this.config)).head   (...args);\r\n    http.post    = async (...args)=> (await loadAsyncHeaders(this.config)).post   (...args);\r\n    http.put     = async (...args)=> (await loadAsyncHeaders(this.config)).put    (...args);\r\n    http.patch   = async (...args)=> (await loadAsyncHeaders(this.config)).patch  (...args);\r\n    http.delete  = async (...args)=> (await loadAsyncHeaders(this.config)).delete (...args);\r\n    http.options = async (...args)=> (await loadAsyncHeaders(this.config)).options(...args);\r\n    http.request = async (...args)=> (await loadAsyncHeaders(this.config)).request(...args);\r\n\r\n    this.http = http;\r\n  }\r\n}\r\n\r\nasync function loadAsyncHeaders(baseConfig) {\r\n\r\n  const { token, tokenType, ...config } = baseConfig || {}\r\n\r\n  const headers = { ...(config.headers || {}) };\r\n\r\n  if(token) {\r\n      headers.Authorization = `${tokenType||'Bearer'} ${token}`;\r\n  }\r\n\r\n  return axios.create({ ...config, headers } );\r\n\r\n}\r\n\r\n//////////////////////////\r\n// Helpers\r\n////////////////////////\r\n\r\nexport function tryCastToApiError(error) {\r\n\r\n  if(error && error.response && error.response.data && error.response.data.code) {\r\n      const apiError = error.response.data\r\n      throw error.response.data;\r\n  }\r\n\r\n  throw error\r\n}\r\n\r\nexport function stringifyUrlParam(value) {\r\n  if (value instanceof(Date))   {return value.toISOString()}    \r\n  if (value instanceof(Object)) {return JSON.stringify(value)}  \r\n  return value; \r\n}\r\n\r\nexport function stringifyUrlParams(valueObj) {\r\n  const returnObj = {};\r\n\r\n  for (const [key, value] of Object.entries(valueObj)) {\r\n    if (isValid(value)){\r\n      returnObj[key] = stringifyUrlParam(value);\r\n    }\r\n  }\r\n  \r\n  return returnObj;\r\n}\r\n\r\nexport function mapObjectId(id){  \r\n  return isObjectId(id)? { $oid: id } : id\r\n}\r\n\r\nexport function isObjectId(id){\r\n  return /^[a-f0-9]{24}/i.test(id);\r\n}\r\n\r\nexport function isValid(params){\r\n  return ![undefined, null].includes(params);\r\n}","/**\r\n * @vitest-environment jsdom\r\n */\r\n\r\ntest('use jsdom in this test file', () => {\r\n  const element = document.createElement('div')\r\n  expect(element).not.toBeNull()\r\n})\r\n\r\nimport { expect, test } from 'vitest'\r\nimport { mapObjectId, isObjectId, stringifyUrlParam, stringifyUrlParams } from './api-base'\r\n\r\ntest('isObjectId Test:', () => {\r\n   expect.soft(isObjectId(1)).toBe(false);\r\n   expect.soft(isObjectId(\"aaaabbbbccccdddd00001111\")).toBe(true);\r\n})\r\n\r\ntest('mapObjectId Test:', () => {\r\n    expect.soft(mapObjectId(\"aaaabbbbccccdddd00001111\")).toEqual({$oid: \"aaaabbbbccccdddd00001111\" });\r\n})\r\n\r\ntest('Params -> URL Param',() => {\r\n  expect.soft(stringifyUrlParam(\"I am a string\")).toEqual(\"I am a string\");\r\n  expect.soft(stringifyUrlParam(1)).toBe(1);\r\n  expect.soft(stringifyUrlParam(new Date(\"2024-09-13T05:00:00.000+05:00\"))).toBe(\"2024-09-13T00:00:00.000Z\");\r\n  expect.soft(stringifyUrlParam({name: \"John\", age: 30, city: \"New York\"})).toEqual('{\"name\":\"John\",\"age\":30,\"city\":\"New York\"}');\r\n}) \r\n\r\n\r\ntest('Param list -> URL Params',() => {\r\n  expect.soft(stringifyUrlParams({q:1, f:2, s:1, sk:0, l:0 , c:0, fo:1, ag:1})).toEqual({\"q\":1,\"f\":2,\"s\":1,\"sk\":0,\"l\":0,\"c\":0,\"fo\":1,\"ag\":1 });\r\n  expect.soft(stringifyUrlParams({q:{firstName:\"john\",lastName:\"smith\"}, f:2, s:1, sk:0, l:0 , c:0, fo:1, ag:1})).toEqual({\"q\":'{\"firstName\":\"john\",\"lastName\":\"smith\"}',\"f\":2,\"s\":1,\"sk\":0,\"l\":0,\"c\":0,\"fo\":1,\"ag\":1 });\r\n}) \r\n\r\n\r\n\r\n \r\n\r\n\r\n\r\n\r\n"],"names":["Vue","test","expect"],"mappings":"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"}